<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Deploying Multiple Rails Applications to a Single VPS</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, devops, docker, climbing and startups" />
    
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />

   
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RubyFlow"
    href="/rss.xml"/>

</head>
<body class="home-template">

    
    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>
        
        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">Deploying Multiple Rails Applications to a Single VPS</h1>

        <section class="post-content">
            <p>When I announced the release of my book, <a href="https://leanpub.com/deploying_rails_applications">deploying rails applications</a>, one of the most common questions I got was whether it covered deploying multiple apps to a single VPS. It does and since there was so much interest, I&#39;ve put together a brief tutorial and sample code on the basics.</p>

<h2>Pre-requisites</h2>

<p>I&#39;m assuming you have a VPS setup with Nginx and your database server of choice. You&#39;ll need to have SSH access to this server and I&#39;ll assume you&#39;ve already copied your public key across.</p>

<p>This tutorial has been tested with my example configuration, full instructions for setting up a VPS with this configuration is available here: <a href="http://www.talkingquickly.co.uk/2013/09/using-chef-to-provision-a-rails-and-postgres-server/">http://www.talkingquickly.co.uk/2013/09/using-chef-to-provision-a-rails-and-postgres-server/</a></p>

<h2>Which version of Capistrano to use</h2>

<p>Capistrano 3 is currently available however in this tutorial I&#39;ll be using Capistrano 2. The focus of this tutorial is primarily on the configuration required for running multiple applications on a single VPS rather than how to use Capistrano so it should still be relevant even if you prefer Capistrano 3.</p>

<p>I&#39;m generally quite conservative on which tools to use for provisioning and deployment, as version 3 gains more traction and becomes better tested, I&#39;ll look at doing an updated version.</p>

<h2>Setting up</h2>

<p>Begin by adding the Capistrano Gem to your gemfile in the development group:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt;2.15&#39;</span>
<span class="k">end</span>
</code></pre></div>
<p>You&#39;ll also need to the Unicorn Gem:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
<span class="k">end</span>
</code></pre></div>
<p>And then run <code>bundle install</code>.</p>

<p>Once this completes, in the root of your project, run:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">capify .
</code></pre></div>
<p>This will create two files:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">./Capfile
./config/deploy.rb
</code></pre></div>
<p>In the simplest possible configuration, your deployment target can be defined directly in <code>deploy.rb</code> and deployments can be initiated by a simple <code>cap deploy</code>. We&#39;ll take a slightly more modular approach which allows for the easy addition of multiple environments - for example testing and staging - at a later date.</p>

<p>Update deploy.rb to contain the following:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;bundler/capistrano&quot;</span>

<span class="c1"># enable multistage</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/ext/multistage&#39;</span>

<span class="c1"># define our stages, remember that if it isn&#39;t defined here</span>
<span class="c1"># it won&#39;t be picked up.</span>
<span class="n">set</span> <span class="ss">:stages</span><span class="p">,</span> <span class="sx">%w(production)</span>
<span class="n">set</span> <span class="ss">:default_stage</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span>

<span class="c1"># simple method to create a file from an erb template. Used</span>
<span class="c1"># to generate dynamic configuration files.</span>
<span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
    <span class="n">erb</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
    <span class="n">put</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">),</span> <span class="n">to</span>
<span class="k">end</span>
</code></pre></div>
<p>This enables Capistrano Multistage and defines the different stages we&#39;re going to want to deploy to, to begin with just a production environment. It then defines a simple helper method for taking an erb template and generating a file.</p>

<p>Next create a new directory <code>deploy</code> within the config directory.</p>

<h2>Defining a production stage</h2>

<p>A very simple production capistrano staging template is available at:</p>

<p><a href="https://github.com/TalkingQuickly/capistrano_stage">https://github.com/TalkingQuickly/capistrano_stage</a></p>

<p>Or you can download a zip here: <a href="https://github.com/TalkingQuickly/capistrano_stage/archive/master.zip">https://github.com/TalkingQuickly/capistrano_stage/archive/master.zip</a></p>

<p>Copy these files into <code>config/deploy</code> and open production.rb.</p>

<p>This file is named to correspond with the stage name defined in deploy.rb. Later when we run <code>cap production deploy</code>, capistrano will look for the file config/deploy/production.rb and deploy to the stage defined there.</p>

<p>The file is commented in detail so we&#39;ll only cover the key elements here.</p>

<p>To begin with the following variables will need to be set for your application:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># this should be the the server address or ip you&#39;ll be deploying to</span>
<span class="n">server</span> <span class="s2">&quot;your-server-address-or-ip&quot;</span><span class="p">,</span> <span class="ss">:web</span><span class="p">,</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:db</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>

<span class="c1"># set RAILS_ENV</span>
<span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>

<span class="c1"># the name of your application</span>
<span class="n">set</span> <span class="ss">:application_name</span><span class="p">,</span> <span class="s2">&quot;your_app_name&quot;</span>

<span class="c1"># the domain you&#39;ll be deploying your application to</span>
<span class="n">set</span> <span class="ss">:application_domain</span><span class="p">,</span> <span class="s2">&quot;domain.example.com&quot;</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="c1"># the details of the source control where the codebase should be</span>
<span class="c1"># retrieved from from</span>
<span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span>
<span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s2">&quot;your_git_repo&quot;</span>
<span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</code></pre></div>
<p>These variables are then propogated automatically to the config files created in setup.</p>

<h2>Setup</h2>

<p>production.rb defines a task <code>setup_config</code> which is called when we run <code>cap deploy production:setup</code>. This task is responsible for creating all configuration specific to our application on the server we&#39;re deploying to.</p>

<p>In this simple stage definition there are four key pieces of configuration which are created.</p>

<h3>database.yml</h3>

<p>It&#39;s good practice not to store details of our production database in source control. Therefore the setup task will copy the databaes.sample.yml template to the shared folder on the remote server and you can SSH in, rename this file to database.yml and enter the production database details.</p>

<p>Whenever the application is deployed, the task <code>symlink_config</code> will create a link from app_root/config/database.yml to this shared file.</p>

<h3>unicorn.rb.erb</h3>

<p>This defines the configuration for the Unicorn web server. It also ensures that pidfiles are created for the unicorn worker processes which allows them to be monitored and managed if you choose to implement zero downtime deployments.</p>

<p>The key variable to set here is:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">worker_processes</span> <span class="mi">1</span>
</code></pre></div>
<p>This defines the number of worker processes which unicorn will spawn. The more worker processes, the more concurrent connections can be handled. Worker processes will run continually and consume a fairly consistent amount of RAM irrespective of whether they are handling a request or not. You&#39;ll therefore need to tune the number of worker processes depending on:</p>

<ul>
<li>  The amount of RAM available</li>
<li>  The number of applications running on the server</li>
<li>  the number of cores available</li>
</ul>

<h3>unicorn_init.sh.erb</h3>

<p>This is copied to <code>/etc/init.d/unicorn_application</code> and manages the starting, stopping and restarting of unicorn worker processes. The following key commands are available:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">/etc/init.d/unicorn_application restart
/etc/init.d/unicorn_application start
/etc/init.d/unicorn_application stop
</code></pre></div>
<h3>nginx.conf</h3>

<p>This is an nginx virtual host file which directs traffic to the domain set as application_domain in production.rb to the unicorn workers.</p>

<h2>Deploying</h2>

<p>Once you&#39;ve populated production.rb with the details of your application. Run:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">cap production deploy:setup
</code></pre></div>
<p>This will create the configuration files on the remote server. Then SSH into the server, navigate to the shared directory and copy the database.example.yml to database.yml and enter the details of your database server.</p>

<p>You&#39;re then ready to deploy your application for the first time:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">cap production deploy
</code></pre></div>
<h2>Additional Applications</h2>

<p>Using this approach, each application is responsible for maintaing its own configuration and nginx will proxy requests back to the correct unicorn workers depending on the domain which is accessed so the only limit to the number of rails applications which can be deployed to a single server is the resources available.</p>

<div class="alsoread">
  <p><strong>Popular posts about deploying Rails apps</strong></p>
  <p>
    <a href="/2013/09/using-chef-to-provision-a-rails-and-postgres-server/">
      How to quickly provision a VPS for Rails using Chef
    </a>
    <br/>
    <a href="/2014/01/deploying-rails-apps-to-a-vps-with-capistrano-v3/">
      Deploying with Capistrano 3
    </a>
    <br/>
    <a href="/2013/12/tailing-log-files-with-capistrano-3/">
      Tailing log files with Capistrano 3
    </a>
    <br/>
    <a href="/2013/10/using-vagrant-to-test-chef-cookbooks/">
      Using Vagrant to test Chef Cookbooks
    </a>
    <br/>
    <a href="/2013/11/deploying-multiple-rails-apps-to-a-single-vps/">
      Deploying with Capistrano 2
    </a>
  </p>
</div>

        </section>

        

        <footer class="post-footer">
          
          
            <section class="book">
  <header>
    <a href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer_image">
      <img
      src="/assets/images/deploying_rails_applications_cover.jpeg"
      />
    </a>
  </header>
  <article>
    <h4>Reliably Deploying Rails Applications Book</h4>
    <p>My book, Reliably Deploying Rails Applications covers every step of the deployment
    process from setting up a VPS from scratch with Chef, to deploying
    and day to day maintenance with Capistrano 3.</p>
    <p><a
      href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer"
      target="_blank">You
      can purchase it from leanpub here</a> or enter your email below to
    read a sample chapter.</p>
    <div id="mc_embed_signup">
<form action="http://hillsbede.us5.list-manage.com/subscribe/post?u=68b84d48aa7cec1155bee1a0c&amp;id=73f32eb74a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" novalidate="">
  
  <input placeholder="Email Address" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" style="height:28px;padding: 0 10px 0 10px;">

<input type="submit" value="Get the sample chapter" name="subscribe" id="mc-embedded-subscribe" class="button" style="background-color: #aaa;border: 0 none;border-radius: 4px;color: #FFFFFF;display: inline-block;font-size: 15px;font-weight: bold;height: 32px;line-height: 32px;margin: 0 5px 10px 10px;padding: 0 10px 0 10px;text-align: center;text-decoration: none;vertical-align: top;white-space: nowrap;width: auto;">
</form>
</div>
  
  </article>
</section>

          
          

            
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy;  &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>

    
    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
