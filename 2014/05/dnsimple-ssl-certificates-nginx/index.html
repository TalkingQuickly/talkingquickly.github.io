<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>DNSimple SSL Certificates and NGinx</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, devops, docker, climbing and startups" />
    
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />

   
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RubyFlow"
    href="/rss.xml"/>

</head>
<body class="home-template">

    
    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>
        
        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">DNSimple SSL Certificates and NGinx</h1>

        <section class="post-content">
            <p>If you purchase a Geotrust SSL Certificate from DNSimple for your domain, there&#39;s a small amount of setup required to get the certificate in a format you can use with Nginx. This post includes an overview of the process and a simple bash script to automate it.</p>

<p>You&#39;ll have three certificate files:</p>

<ul>
<li>Your Certificate</li>
<li>Primary Intermediate CA</li>
<li>Secondary Intermediate CA</li>
</ul>

<p>These have to be concatinated into one file in the order:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">YOUR CERTIFICATE
SECONDARY INTERMEDIATE CA
PRIMARY INTERMEDIATE CA
</code></pre></div>
<p>E.g:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">cat my.crt secondary.crt primary.crt &gt; ssl_cert.crt
</code></pre></div>
<p>Start with 4 files:</p>

<ul>
<li>my.crt</li>
<li>secondary.crt</li>
<li>primary.crt</li>
<li>ssl_private_key.key.new</li>
</ul>

<p>Assuming your destination files are <code>ssl_cert.crt</code> and <code>ssl_private_key.key</code></p>

<p>The following bash script provides a simple interface for switching in new certs and rolling back in the case that something goes wrong. The script should be stored in the same directory as the target for the certificates. In the case of our sample configuration, this is <code>/home/deploy/your_app_environment/shared/</code>.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-lt <span class="m">1</span> <span class="o">]</span>
<span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage : $0 command&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Expects: my.crt, secondary.crt, primary.crt, ssl_private_key.key.new&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Commands:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;load_new_certs&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;rollback_certs&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;cleanup_certs&quot;</span>
        <span class="nb">exit</span>
<span class="k">fi</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in

load_new_certs<span class="o">)</span>  <span class="nb">echo</span> <span class="s2">&quot;Copying New Certs&quot;</span>
    cat my.crt secondary.crt primary.crt &gt; ssl_cert.crt.new

    mv ssl_cert.crt ssl_cert.crt.old
    mv ssl_cert.crt.new ssl_cert.crt

    mv ssl_private_key.key ssl_private_key.key.old
    mv ssl_private_key.key.new ssl_private_key.key

    sudo service nginx reload
    <span class="p">;;</span>
rollback_certs<span class="o">)</span>  <span class="nb">echo</span>  <span class="s2">&quot;Rolling Back to Old Certs&quot;</span>
    mv ssl_cert.crt ssl_cert.crt.new
    mv ssl_cert.crt.old ssl_cert.crt

    mv ssl_private_key.key ssl_private_key.key.new
    mv ssl_private_key.key.old ssl_private_key.key

    sudo service nginx reload
    <span class="p">;;</span>
cleanup_certs<span class="o">)</span>  <span class="nb">echo</span>  <span class="s2">&quot;Cleaning Up Temporary Files&quot;</span>
    rm ssl_cert.crt.old
    rm ssl_private_key.key.old
    rm my.crt
    rm secondary.crt
    rm primary.crt
    <span class="p">;;</span>
*<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Command not known&quot;</span>
   <span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div>
<p>Don&#39;t forget to make the script executable with <code>chmod +x script_name.sh</code>.</p>

<p>You can then simply run:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">./script_name load_new_certs
</code></pre></div>
<p>to swap in the new certificates and reload nginx. If, after testing the site, something isn&#39;t right, you can execute:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">./script_name rollback_certs
</code></pre></div>
<p>To revert to the previous ones. And then repeat <code>load_new_certs</code> once you&#39;ve resolved the issue.</p>

<p>Once you have the new certificates working as intended, you can use:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">./script_name cleanup_certs
</code></pre></div>
<p>To remove the temporary and legacy files created.</p>

        </section>

        

        <footer class="post-footer">
          
            <!-- If we want to display author's name and bio -->

    <section class="author">
      <header> <a href="/about.html"> <img class="profile"
          src="/assets/images/profile2.jpg" alt="Ben Dixon. Without
      Aviators."></a></header>
      <article>
        <!-- Author Name -->
          <h4> Ben Dixon </h4>
          <!-- Author Bio -->
          <p> 
          I'm a Ruby/ Android Developer, devops geek, lover of good coffee and making things. I'm the author of <a href="https://leanpub.com/deploying_rails_applications" target="_blank">Reliably Deploying Rails Applications</a> and currently based in London. <a href="/travel">Travel</a> addict often to be found exploring Europe, America and Asia. Co-founded <a href="https://www.makeitwithcode.com" target="_blank">Make It With Code</a>, <a href= "http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a> on twitter. 
          </p>
        </article>
    </section>                


          
          
          

            
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy;  &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>

    
    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
